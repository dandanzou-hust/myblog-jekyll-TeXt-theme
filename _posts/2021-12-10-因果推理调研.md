---
title:  "【技术分享】因果推理"
date:   2021-12-10 12:00:00 +0800
key: casual_inference
categories: 技术分享
tag: "因果推理"
---

## 因果分析介绍

因果关系描述的是系统中一个事件（因素）和第二个事件（因素）之间的作用关系。其中前一件事是后一件事的起因，后一件事是前一件事的结果。因果关系具有以下几种特点：

- 时序性：在不考虑量子力学的前提下，一般来说，原因都要发生在结果前面。但也有例外，比如鸡生蛋，蛋生鸡的问题，就很难界定谁先谁后。

- 非对称性：一般来说，因果关系是不对称的。即能从因推向果，但是不能从果倒推回来。因此，在表示中一般用有向无环图（Directed Acyclic Graph, DAG）表示.

![img](https://gitee.com/ddzou/my-picture-bed-on-gitee/raw/master//markdown-picture//clip_image001.jpg)

## 因果分析分类

### 原因 -> 结果   

因果推断(Causal Inference)，又称因果推理，因果推断法。

场景：策略调整

- A/B实验
  - Microsoft ：调整页面颜色，提高点击率
  - Airbnb
  - 推荐系统
  - 新冠疫苗
  - [因果推断在阿里文娱用户增长中的应用](https://mp.weixin.qq.com/s?__biz=MzU1NTMyOTI4Mw==&mid=2247499255&idx=1&sn=a7a6427c6c2bd74c728ef2d53c736814)
  - [快手因果推断与实验设计](https://zhuanlan.zhihu.com/p/399274589)


方法：

- [随机实验（A/B实验）](https://zhuanlan.zhihu.com/p/346602966)
- 倾向评分匹配 PSM
- 断点归因  断点回归, RDD
- 双重差分 DID
- Uplift

### 原因 <- 结果 

场景：异常分析，找到导致异常的原因

- DAU下降

方法

- **鱼骨图分析**
- 五个“为什么”分析

### 原因 <-> 结果

- 公式推导

### 事件性因果和过程性因果

事件性因果：结构因果模型**（SCM, Structural Causal Model）**





## 因果分析发展趋势

原因 -> 结果

> 元分析，多个随机试验的整合
>
> 因果推断（结合机器学习）

原因 <- 结果

> ​	破解创新，逻辑不适恰，奇点下移，新的底层假设

## 因果推理的工具

Dowhy、Causal ML、EconML、causalToolbox

![img](https://gitee.com/ddzou/my-picture-bed-on-gitee/raw/master//markdown-picture//v2-f276576b67ee0e55a32955d8e6b24172_r.jpg)

### EconML + DoWhy

Step0 加载数据

Step1 Modeling

第一步是将我们的领域知识编码成一个因果模型，通常用graph来表示。因果推理分析的结果很大程度上依赖输入假设，因此这一步非常重要。为了估计因果效应，大部分常见的问题涉及指定两类变量：

混杂变量（Confounders）：这些是干预和outcome的共同的cause。因此，任何观察到的干预和outcome之间的相关性可能只是由于混杂变量，而不是由于干预和outcome之间的因果关系；

工具变量（Instrumental Variables）：这些是导致干预的特殊变量，但并不直接影响outcome。此外，它们不受任何影响outcome的变量的影响。如果使用正确的方式，工具变量可以帮助减少偏差。

 

Step2 Identification

提供领域知识的两种方式（通过混淆因子和工具变量的命名变量集，或通过因果图）都对应于一个潜在的因果图。给定一个因果图和一个目标量（如A对B的影响），identification的过程是检查给定观测变量是否可以估计目标量。重要的是，identification只考虑观测数据中可用的变量；它不需要数据本身。

 

Step3 Estimation

顾名思义，在估计步骤来构建一个estimator，该estimator可以计算在上一步中确定的estimand identified。许多估计estimators已经被提出用于因果推理。DoWhy实现了一些标准的estimators，而EconML实现了一组使用机器学习方法的估计器。

 

Step4 Refutation

最后，检查估计的鲁棒性是因果分析中最重要的一步。我们使用步骤1-3获得了一个估计值，但每个步骤可能都做出了某些假设，但这些假设可能是错的。如果没有一个合适的验证集，这一步可以依赖反驳测试（refutation tests），该测试使用一个estimator的属性来反驳所获得的估计的正确性。例如，反驳测试（placebo_treatment_refuter）检查当干预变量被随机变量替换时，estimator返回估计值0是否与所有其他变量独立。

 

使用DoWhy+EconML库进行因果推理。DoWhy为这四个步骤提供了通用API，EconML为估算步骤提供了高级Estimator。



## Dowhy

>  **DoWhy: An End-to-End Library for Causal Inference**

因果推理的两个挑战：

1. 最大的挑战之一是建模假设的实践（即，将领域知识转换为因果图）以及这些假设对因果识别和估计的影响。——什么是正确的模型？
2. 另一个挑战是核查和测试实践的转变。与可使用保留测试数据验证的有监督机器学习模型不同，因果任务通常没有可用的基本事实答案。因此，检查核心假设并应用敏感性测试对于获得结果的信心至关重要。——但如何检验这些假设呢？

在幕后，DoWhy构建了两个最强大的因果推理框架：graphical models (Pearl, 2009) and potential outcomes（Imbens和Rubin，2015）。它使用基于图形的标准和微积分来建模假设和识别非参数因果效应。对于评估，它转向主要基于潜在结果的方法。DoWhy还可以与实现评估步骤的其他库进行互操作。它目前支持调用EconML（微软研究院，2019年）和CausalML（Chen等人，2020年）估计器。

## 因果分析和机器学习

因果分析和机器学习（当然主要是监督学习）的共通之处在于二者输入和任务的形式的高度相似性。

简单来说，两类方法的最终输入都是结构化数据。你有一个因变量（dependent variable或者叫outcome或者叫response），有一个或者一堆自变量（independent variable或者叫feature），有好多的个案（case或者叫observation或者叫example）。最后的目的都是对自变量进行一通操作来去“近似”这个因变量。

隔阂就在于使用两类方法的根本目的是不一样的。使用计量经济学方法目的是进行结构分析，也就是说我们最后是想知道哪些自变量会对因变量产生影响，影响有多大；与之不同，使用机器学习方法的目的就是用一大堆自变量去预测因变量。

在前者的框架下，我们不太关注模型拟合得好不好，能不能做预测，只关注变量的系数和显著性。我只需要知道吸烟会对人的寿命产生什么样的影响就好了，并不指望着能用吸不吸烟、每天吸多少根烟这样的信息去预测一个人能活多少岁。

 

在后者的框架下，我们只关注模型拟合得怎么样、到底能不能有好的预测效果。现实问题都是复杂的，所以为了进行有效的预测，被使用的因变量可能会有成千上万个。我们根本不关注到底是哪些变量是显著的、哪些的确起了预测作用或者某个具体变量对因变量有多大的影响。

 

从这个意义上来看，很多人都总结说计量经济学模型是可解释的，机器学习算法是不可解释的。计量经济学模型清清楚楚明明白白，在大多数情况下我们从数学关系上就能够明白某个自变量对因变量的影响到底是怎样的、影响有多大；机器学习算法为了提升预测性能而主动放弃了被解释的能力，比如说模型里会被加入许多的变量的高阶项、乘积项，或者对变量进行一些非线性的转换，或者是降维。最后的确成功把因变量预测出来了，但是哪些变量起了多大作用已经说不清楚了，或者说也没必要弄清楚。

完整地运用一个计量经济学方法是需要若干步骤的，我们可以在那些不要求有可解释性的步骤使用机器学习方法。

 

参考：https://zhuanlan.zhihu.com/p/375273274



## 其他

### 图论和图模型

图论(Graph theory)为该问题提供了一种基于图形编码思想的、更简洁的独立关系表示方法。在图论中，图(Graph是一种基本结构，相当于一组对象，其中一些对象在某种意义上是“相关的”。在计算机科学中，图被常用于机器学习、数据挖掘、通信网络、社交网络、图像处理以及生物信息等领域。

![img](https://gitee.com/ddzou/my-picture-bed-on-gitee/raw/master//markdown-picture//clip_image003-16391294888571.jpg)

在概率推理中，图的主要用途是被赋予概率解释，建立有向图(或无向图)与概率之间的联系，例如图中节点表示随机变量，边表示随机变量间存在的概率关系。从本质上讲，如果两个节点在图上没有一条路径相连，它们就是独立的，否则就是依赖的(或相关的)。

图模型(概率图模型)系统地描述了概率分布的独立(或依赖)关系。每种图模型都是图和概率构造的一个特定的并集，并详细说明了独立关系的表现形式。一般来说，图模型中的图形表示有两个常用的表达策略，即贝叶斯网络和马尔可夫随机场。这两种分支算法都包含了因式分解和独立的性质，但它们的不同之处在于它们编码独立关系所涉及的变量集合以及针对分布的因式分解方法[f}}l。在实际应用中，一般首先用概率模型来描述问题环境，然后再进行推理(相当于进行概率推理)。因此该过程包含两个部分:

1)建模:在确定问题环境的所有潜在相关变量之后，图模型的任务是描述这些变量如何相互作用。通常利用对所有变量的联合概率分布形式的结构性假设来实现，对应于变量间独立性的假设。

2)推理:一旦关于变量如何相互作用的基本假设形成(即完成概率模型的构建过程)，函需解决的问题就可以通过对分布进行概率推理得到回答。

图模型的学习框架提供了发现和分析复杂分布中结构的算法，以简明地描述结构并提取非结构化信息，使其能够被有效地构建和利用。图模型的应用包括因果推理、信息提取、语音识别以及计算机视觉等领域。

 

### VALSE Webinar: 因果推理与学习

三种场景：

![image-20220104104551796](https://gitee.com/ddzou/my-picture-bed-on-gitee/raw/master//markdown-picture//image-20220104104551796.png)

### NFV + 因果的思考：

解决的问题：传统机器学习只会给相关性，无法解释因果性

 NFV中，需要找到“根因“。

 

目前的困难：

1. 数据：kpi数据或是其他，哪些能帮助计算因果关系。

2. 因果关系需要人工提供一张初始的有向无环图，直接决定因果性的效果。

有一些算法可帮助建立初步的因果图，但是肯定效果不如人工。

3. NFV中想找的“根因”，其究竟与时间是否有关系？

目前定位错误的方法：从空间和时间上综合分析，图结构中告警最多，边最多的单元。

 

### 2022年的因果推理方向：

业务中确实存在一定的需求：

1. 如去年资费满意度分类、离网预警分类中，都希望能获取影响用户满意的重要特征，这就是分析因果性。当时的做法，一种是用逻辑回归拟合，给出系数。一种是决策树输出的特征重要性。都仅仅是“相关性”。

2. NFV中，仅使用规则虽然效果好，但是对于告警的根因也需要一定的解释，能画出有向无环图更好！

因果推理的实际作用：

可解释性，便于借助因果性确定产品后续迭代的方向。

### 因果推理的大组：

Susan Athey (Stanford) google大概60万引用

David Sontag(MIT)

Nathan Kallus (Cornell)

vmihaela van der schaar (UCLA)

### 因果推理和知识图谱

#### casual-graph

> 论文：Causal diagrams for empirical research, Judea Pearl, 1995



Casual And-Or Graph (C-AOG)



[知识图谱与因果图挖掘结合的异常根因识别机制](https://gitee.com/ddzou/my-picture-bed-on-gitee/raw/master/literature/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E4%B8%8E%E5%9B%A0%E6%9E%9C%E5%9B%BE%E6%8C%96%E6%8E%98%E7%BB%93%E5%90%88%E7%9A%84%E5%BC%82%E5%B8%B8%E6%A0%B9%E5%9B%A0%E8%AF%86%E5%88%AB%E6%9C%BA%E5%88%B6.pdf)



### 用户感知：对指标的分析方法

回归分析方法：Logistic、Probit 回归分析方法

数据挖掘方法：关联规则分析、聚类分析

网络建模方法：支持向量机、人工神经网络ANN

结构方程模型SEM



因果推理的教科书：
